//This code has been written by Anupam Kumar , 11940160

function afterFormSubmission()//executes whenever a form is submitted
{
  var sheet=SpreadsheetApp.getActiveSheet();
  var lastrow=sheet.getLastRow();
  var data=sheet.getRange(lastrow,2,1,7).getValues();//returns 2d array object data
  var name=data[0][0];
  var email=data[0][1];
  var roll=data[0][2];
  var district=data[0][3];
  var state=data[0][4];
  var country=data[0][5];
  var pin=data[0][6];
 
  //code for Q1.2
  var doc = DocumentApp.create('Response for  ' + name).addEditor(email);//creating document for storing response
  var body = doc.getBody();
  var table = [['Name', 'Email-ID', 'Roll Number', 'District', 'State', 'Country', 'Pin code']];
  table.push([name,email,roll,district,state,country,pin]);//inserting responses
  body.insertParagraph(0, doc.getName()).setHeading(DocumentApp.ParagraphHeading.HEADING1);
  table = body.appendTable(table);
  table.getRow(0).editAsText().setBold(true);//making the headings bold i.e. row 0 bold
  doc.saveAndClose();
  
   MailApp.sendEmail({//sending responses through mail
    to:email,
    subject: 'Welcome '+name,
     body: 'Thanks for filling out the Google form. \n\n Here is the URL of your document containing your responses. Click here to view:'+doc.getUrl(),
     
  });
  
  
  var info=sheet.getDataRange().getValues();//returns 2D object containing entries of whole spreadsheet

  
    //code for Q1.3
    for(var i=1;i<info.length-1;i++){
    if(roll==info[i][3]){//roll numbers matching
      if(email!=info[i][2]){//Case 2 is true
        //sending alert mail to the person who filled the form right now
         MailApp.sendEmail(email, 'Refill the form correctly!!', 'Hello,\nYou have probably filled out some of the informations in the previous form incorrectly.\n Please correct it and fill it again .\n click here to do so:https://forms.gle/ZsTiJppjLyERdDYbA');
        //sending alert mail to person with whom the roll number matched
         MailApp.sendEmail(info[i][2], 'Alert: Roll number matching!!', 'Your roll number was found to match with another student.\n Please verify that you entered the right informations in the form by checking the previous mail which contains your response document.\n To refill the form , click here:https://forms.gle/ZsTiJppjLyERdDYbA');
         sheet.deleteRow(lastrow);//delete the latest incorrect entry made
         }
       else{//case 1 is true
         sheet.deleteRow(i+1);//delete the earlier response of this person and insert the new response at the end
         MailApp.sendEmail(email, 'Data updated!!', 'Thank you for filling out the form again ,\n Your data has been successfully updated. Check the previous mail for your updated responses');
         }
      }
   }
    SpreadsheetApp.flush();//applies all pending spreadsheet changes
   
   
  
  //code for Q1.4
  var k=0;//counter variable for index of samepin
  var samepin=['empty'];//1-D string array for storing names of the student with same pin code and is initialised to 'empty'
  for(var i=1;i<info.length-1;i++){
    if(pin==info[i][7]){//pin codes are same
      samepin[k]=info[i][1];//adding the person's name in the array
      k++;
      }
  }
    if(samepin[0]!='empty'){//pin code is matching with someone
      var docsamepin=DocumentApp.create('Other students from your place. ').addEditor(email);//creating document for storing names with whom pin codes are matching
      var bodysamepin=docsamepin.getBody();
      var tablesamepin=[['NAME']];//heading of document
      for(var j=0;j<k;j++){
        tablesamepin.push([samepin[j]]);//filling in entries
      }
      bodysamepin.insertParagraph(0, docsamepin.getName()).setHeading(DocumentApp.ParagraphHeading.HEADING1);
      tablesamepin = bodysamepin.appendTable(tablesamepin);
      tablesamepin.getRow(0).editAsText().setBold(true);//making the heading bold
      docsamepin.saveAndClose();
      //sending mail to the student containing the list of students with same pin code as his/her 
      MailApp.sendEmail(email, 'Additional Information!', 'Hi '+name+',\nHere is the list of the students who have same pin code as yours.\nClick on this URL to view:'+docsamepin.getUrl());
    }
     
        
}
  